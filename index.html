<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détecteur de Discontinuités de Câbles</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-ok {
            background-color: #28a745;
        }
        .status-discontinu {
            background-color: #dc3545;
        }
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .header {
            background-color: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .debug-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .debug-section pre {
            max-height: 150px;
            overflow-y: auto;
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center">
            <h1 class="display-4">Détecteur de Discontinuités de Câbles</h1>
            <p class="lead">Identifiez les câbles avec des discontinuités dans le réseau</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Chargement des données</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Sélectionnez un fichier CSV</label>
                            <input class="form-control" type="file" id="csvFile" accept=".csv">
                        </div>
                        <div class="mb-3">
                            <label for="delimiterSelect" class="form-label">Séparateur CSV</label>
                            <select class="form-select" id="delimiterSelect">
                                <option value=";" selected>Point-virgule (;)</option>
                                <option value=",">Virgule (,)</option>
                                <option value="\t">Tabulation</option>
                            </select>
                        </div>
                        <button id="analyseBtn" class="btn btn-primary">Analyser</button>
                        <button id="loadSampleBtn" class="btn btn-secondary">Charger l'exemple</button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Statistiques</h5>
                    </div>
                    <div class="card-body">
                        <div id="stats">
                            <p>Câbles analysés: <span id="totalCables">0</span></p>
                            <p>Câbles avec discontinuités: <span id="totalDiscontinuites">0</span></p>
                            <div class="progress mb-3">
                                <div id="progressBar" class="progress-bar bg-danger" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                            </div>
                            <p>Discontinuités à l'extrémité 1: <span id="extremite1">0</span></p>
                            <p>Discontinuités à l'extrémité 2: <span id="extremite2">0</span></p>
                            <p>Discontinuités aux deux extrémités: <span id="deuxExtremites">0</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Résultats de l'analyse</h5>
                <div>
                    <button id="exportBtn" class="btn btn-light btn-sm" disabled>Exporter en CSV</button>
                    <button id="filterBtn" class="btn btn-light btn-sm">Afficher uniquement les discontinuités</button>
                    <button id="debugBtn" class="btn btn-warning btn-sm">Debug</button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-container">
                    <table id="resultTable" class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Code</th>
                                <th>Étiquette</th>
                                <th>Nœud 1</th>
                                <th>Nœud 2</th>
                                <th>Extrémité 1 (BP1)</th>
                                <th>Extrémité 1 (BA1)</th>
                                <th>Extrémité 2 (BP2)</th>
                                <th>Extrémité 2 (BA2)</th>
                                <th>Type</th>
                                <th>Longueur</th>
                            </tr>
                        </thead>
                        <tbody id="resultBody">
                            <!-- Les résultats seront affichés ici -->
                        </tbody>
                    </table>
                </div>
                
                <div id="debugSection" class="debug-section" style="display: none;">
                    <h5>Informations de débogage</h5>
                    <p>Structure des données détectées:</p>
                    <pre id="debugInfo"></pre>
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
        </div>
        <p class="mt-2">Analyse en cours, veuillez patienter...</p>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Éléments DOM
            const csvFileInput = document.getElementById('csvFile');
            const delimiterSelect = document.getElementById('delimiterSelect');
            const analyseBtn = document.getElementById('analyseBtn');
            const loadSampleBtn = document.getElementById('loadSampleBtn');
            const exportBtn = document.getElementById('exportBtn');
            const filterBtn = document.getElementById('filterBtn');
            const debugBtn = document.getElementById('debugBtn');
            const resultBody = document.getElementById('resultBody');
            const loading = document.getElementById('loading');
            const totalCables = document.getElementById('totalCables');
            const totalDiscontinuites = document.getElementById('totalDiscontinuites');
            const progressBar = document.getElementById('progressBar');
            const extremite1El = document.getElementById('extremite1');
            const extremite2El = document.getElementById('extremite2');
            const deuxExtremitesEl = document.getElementById('deuxExtremites');
            const debugSection = document.getElementById('debugSection');
            const debugInfo = document.getElementById('debugInfo');

            // Variables globales
            let allData = [];
            let discontinuitesData = [];
            let showOnlyDiscontinuites = false;
            let columnMappings = {
                bp1: 'cb_bp1',
                ba1: 'cb_ba1',
                bp2: 'cb_bp2',
                ba2: 'cb_ba2',
                code: 'cb_code',
                etiquet: 'cb_etiquet',
                nd1: 'cb_nd1',
                nd2: 'cb_nd2',
                typelog: 'cb_typelog',
                lgreel: 'cb_lgreel'
            };

            // Exemple de données
            const sampleData = `cb_code;cb_codeext;cb_abandon;cb_perirec;cb_etiquet;cb_nd1;cb_nd2;cb_bp1;cb_ba1;cb_bp2;cb_ba2;cb_r1_code;cb_r2_code;cb_r3_code;cb_fo_type;cb_prop;cb_gest;cb_proptyp;cb_statut;cb_dateins;cb_avct;cb_typephy;cb_typelog;cb_rf_code;cb_capafo;cb_fo_disp;cb_fo_util;cb_modulo;cb_cabphy;cb_lgreel;cb_r4_code;cb_user;cb_etat;cb_datemes;cb_tech;cb_diam;cb_color;cb_localis;cb_comment;cb_creadat;cb_majdate;cb_majsrc;cb_abddate;cb_abdsrc
FI000016546007;16546007;0;;M-174/30276-FT / PBO-SRO-BPI-11406794-047 / ST LAURENT D'AIGOUZE;CH000004049918;SU000004534733;EN000012149305;;BL000008248512;;WIGA;ZN3010000263;ZS0000SRO-BPI-11406794;G657A2;PCAB0000000225;GCAB0000000198;CST;REC;2019-11-21 14-53-49;E;C;DI;FI000000000704;24;;;6;16546007;25.93;;;;;;;;;;;;;;
FI000016542461;16542461;0;;M-229/30276-FT / PBO-SRO-BPI-11406794-011 / ST LAURENT D'AIGOUZE;CH000004049589;CH000004258545;EN000012149297;;BL000008248252;;WIGA;ZN3010000263;ZS0000SRO-BPI-11406794;G657A2;PCAB0000000225;GCAB0000000198;CST;REC;2019-11-21 14-52-15;E;C;DI;FI000000000701;48;;;6;16542461;55.93;;;;;;;;;;;;;;
FI000016545991;16545991;0;;PBO-SRO-BPI-11406794-070 / PBO-SRO-BPI-11406794-071 / ST LAURENT D'AIGOUZE;CH000004252826;SU000005070211;BL000008248543;;BL000008248544;;WIGA;ZN3010000263;ZS0000SRO-BPI-11406794;G657A2;PCAB0000000225;GCAB0000000198;CST;REC;2019-11-21 14-53-28;E;C;DI;FI000000000700;24;;;6;16545991;46.3;;;;;;;;;;;;;;
FI000017189526;17189526;0;;BPE-536/30003-FT / BPE-165/30003-FT / AIGUES MORTES;CH000004049271;CH000004047996;EN000012537783;;EN000012537784;;WIGA;ZN3010000263;;G657A;PCAB0000000225;GCAB0000000198;CST;REC;2020-01-27 00-00-00;E;C;TR;FI000000000508;288;;;12;17189526;632.05;;;;;;;;;;;;;;
FI000016545973;16545973;0;;PBO-SRO-BPI-11406794-017 / PBO-SRO-BPI-11406794-018 / ST LAURENT D'AIGOUZE;SU000000849292;SU000000853130;BL000008248491;;BL000008248492;;WIGA;ZN3010000263;ZS0000SRO-BPI-11406794;G657A2;PCAB0000000225;GCAB0000000198;CST;REC;2019-11-21 14-53-05;E;C;DI;FI000000000706;48;;;6;16545973;283.24;;;;;;;;;;;;;;
FI000016546011;16546011;0;;ARM-1830041 / BPE-284/30276-FT / ST LAURENT D'AIGOUZE;PE000001968054;CH000004049267;;BA000010113076;EN000012149299;;WIGA;ZN3010000263;ZS0000SRO-BPI-11406794;G657A2;PCAB0000000225;GCAB0000000198;CST;REC;2019-11-21 14-53-54;E;C;DI;FI000000000712;288;;;12;16546011;128.19;;;;;;;;;;;;;;
FI000017246473;17246473;0;; mM-AC4/30276-FT / ARM-1830041 / ST LAURENT D'AIGOUZE;CH000003691187;PE000001968054;EN000012565625;;;BA000010113076;WIGA;ZN3010000263;;G652D;PCAB0000000225;GCAB0000000198;CST;REC;2020-01-31 00-00-00;E;C;TR;FI000000000316;36;;;12;17246473;7.32;;;;;;;;;;;;;;
FI000016546010;16546010;0;;ARM-1830041 / M-229/30276-FT / ST LAURENT D'AIGOUZE;PE000001968054;CH000004049589;;BA000010113076;EN000012149297;;WIGA;ZN3010000263;ZS0000SRO-BPI-11406794;G657A2;PCAB0000000225;GCAB0000000198;CST;REC;2019-11-21 14-53-53;E;C;DI;FI000000000711;144;;;12;16546010;116.28;;;;;;;;;;;;;;
FI000047496423;47496423;0;;BPE-02/30003-FT / BPE-154/30276-FT / AIGUES MORTES;CH000003120961;CH000004050560;;;;EN000012565617;;WIGA;ZN3010000263;;G657A;PCAB0000000225;GCAB0000000198;CST;REC;2024-11-08 00-00-00;E;C;TR;FI000000000508;288;;;12;47496423;3070.79;;;;;;;;;;;;;;`;
            
            // Fonction pour détecter les colonnes importantes
            function detectColumnMappings(headers) {
                const mappings = {
                    bp1: null,
                    ba1: null,
                    bp2: null,
                    ba2: null,
                    code: null,
                    etiquet: null,
                    nd1: null, 
                    nd2: null,
                    typelog: null,
                    lgreel: null
                };
                
                // Liste des noms possibles pour chaque type de colonne
                const possibleNames = {
                    bp1: ['cb_bp1', 'bp1', 'branchement_1', 'point_branchement_1'],
                    ba1: ['cb_ba1', 'ba1', 'arrivee_1', 'point_arrivee_1'],
                    bp2: ['cb_bp2', 'bp2', 'branchement_2', 'point_branchement_2'],
                    ba2: ['cb_ba2', 'ba2', 'arrivee_2', 'point_arrivee_2'],
                    code: ['cb_code', 'code', 'id', 'identifiant'],
                    etiquet: ['cb_etiquet', 'etiquet', 'etiquette', 'description', 'nom'],
                    nd1: ['cb_nd1', 'nd1', 'noeud_1', 'node_1'],
                    nd2: ['cb_nd2', 'nd2', 'noeud_2', 'node_2'],
                    typelog: ['cb_typelog', 'typelog', 'type', 'type_logique'],
                    lgreel: ['cb_lgreel', 'lgreel', 'longueur', 'length']
                };
                
                // Pour chaque en-tête, vérifier s'il correspond à l'un des noms possibles
                headers.forEach(header => {
                    const headerLower = header.toLowerCase();
                    
                    for (const [type, names] of Object.entries(possibleNames)) {
                        if (names.some(name => headerLower === name.toLowerCase())) {
                            mappings[type] = header;
                        }
                    }
                });
                
                // Si on n'a pas trouvé certaines colonnes critiques, on utilise les valeurs par défaut
                if (!mappings.bp1) mappings.bp1 = 'cb_bp1';
                if (!mappings.ba1) mappings.ba1 = 'cb_ba1';
                if (!mappings.bp2) mappings.bp2 = 'cb_bp2';
                if (!mappings.ba2) mappings.ba2 = 'cb_ba2';
                
                return mappings;
            }
            
            // Fonction pour vérifier si un câble a une discontinuité
            function hasDiscontinuity(row) {
                const extremite1Vide = (row[columnMappings.bp1] === undefined || row[columnMappings.bp1] === null || row[columnMappings.bp1] === '') && 
                                      (row[columnMappings.ba1] === undefined || row[columnMappings.ba1] === null || row[columnMappings.ba1] === '');
                
                const extremite2Vide = (row[columnMappings.bp2] === undefined || row[columnMappings.bp2] === null || row[columnMappings.bp2] === '') && 
                                      (row[columnMappings.ba2] === undefined || row[columnMappings.ba2] === null || row[columnMappings.ba2] === '');
                
                return extremite1Vide || extremite2Vide;
            }

            // Fonction pour analyser le fichier CSV
            function analyseCSV(file) {
                loading.style.display = 'block';
                
                const delimiter = delimiterSelect.value;
                
                Papa.parse(file, {
                    header: true,
                    delimiter: delimiter,
                    skipEmptyLines: true,
                    complete: function(results) {
                        // Détecter les colonnes importantes
                        if (results.meta && results.meta.fields) {
                            columnMappings = detectColumnMappings(results.meta.fields);
                        }
                        
                        // Afficher les informations de débogage
                        debugInfo.textContent = `Mappings des colonnes détectés:\n${JSON.stringify(columnMappings, null, 2)}\n\nPremier enregistrement:\n${JSON.stringify(results.data[0], null, 2)}`;
                        
                        processData(results.data);
                        loading.style.display = 'none';
                        exportBtn.disabled = false;
                    },
                    error: function(error) {
                        console.error('Erreur lors de l\'analyse du CSV:', error);
                        alert('Erreur lors de l\'analyse du fichier CSV');
                        loading.style.display = 'none';
                    }
                });
            }

            // Fonction pour analyser une chaîne CSV
            function analyseCSVString(csvString) {
                loading.style.display = 'block';
                
                const delimiter = delimiterSelect.value;
                
                const results = Papa.parse(csvString, {
                    header: true,
                    delimiter: delimiter,
                    skipEmptyLines: true
                });
                
                // Détecter les colonnes importantes
                if (results.meta && results.meta.fields) {
                    columnMappings = detectColumnMappings(results.meta.fields);
                }
                
                // Afficher les informations de débogage
                debugInfo.textContent = `Mappings des colonnes détectés:\n${JSON.stringify(columnMappings, null, 2)}\n\nPremier enregistrement:\n${JSON.stringify(results.data[0], null, 2)}`;
                
                processData(results.data);
                loading.style.display = 'none';
                exportBtn.disabled = false;
            }

            // Fonction pour traiter les données et mettre à jour l'interface
            function processData(data) {
                allData = data;
                
                // Filtrer les discontinuités
                discontinuitesData = data.filter(row => hasDiscontinuity(row));
                
                // Calculer les statistiques
                const totalCount = data.length;
                const discontinuitesCount = discontinuitesData.length;
                const percentage = totalCount > 0 ? (discontinuitesCount / totalCount * 100).toFixed(2) : "0.00";
                
                // Analyser les types de discontinuités
                const extremite1Count = discontinuitesData.filter(row => 
                    (row[columnMappings.bp1] === undefined || row[columnMappings.bp1] === null || row[columnMappings.bp1] === '') && 
                    (row[columnMappings.ba1] === undefined || row[columnMappings.ba1] === null || row[columnMappings.ba1] === '')
                ).length;
                
                const extremite2Count = discontinuitesData.filter(row => 
                    (row[columnMappings.bp2] === undefined || row[columnMappings.bp2] === null || row[columnMappings.bp2] === '') && 
                    (row[columnMappings.ba2] === undefined || row[columnMappings.ba2] === null || row[columnMappings.ba2] === '')
                ).length;
                
                const deuxExtremitesCount = discontinuitesData.filter(row => 
                    ((row[columnMappings.bp1] === undefined || row[columnMappings.bp1] === null || row[columnMappings.bp1] === '') && 
                     (row[columnMappings.ba1] === undefined || row[columnMappings.ba1] === null || row[columnMappings.ba1] === '')) &&
                    ((row[columnMappings.bp2] === undefined || row[columnMappings.bp2] === null || row[columnMappings.bp2] === '') && 
                     (row[columnMappings.ba2] === undefined || row[columnMappings.ba2] === null || row[columnMappings.ba2] === ''))
                ).length;
                
                // Mettre à jour les statistiques
                totalCables.textContent = totalCount;
                totalDiscontinuites.textContent = `${discontinuitesCount} (${percentage}%)`;
                progressBar.style.width = `${percentage}%`;
                progressBar.textContent = `${percentage}%`;
                progressBar.setAttribute('aria-valuenow', percentage);
                extremite1El.textContent = extremite1Count;
                extremite2El.textContent = extremite2Count;
                deuxExtremitesEl.textContent = deuxExtremitesCount;
                
                // Afficher les données dans le tableau
                renderTable(showOnlyDiscontinuites ? discontinuitesData : data);
            }

            // Fonction pour afficher les données dans le tableau
            function renderTable(data) {
                resultBody.innerHTML = '';
                
                data.forEach(row => {
                    const extremite1Vide = (row[columnMappings.bp1] === undefined || row[columnMappings.bp1] === null || row[columnMappings.bp1] === '') && 
                                         (row[columnMappings.ba1] === undefined || row[columnMappings.ba1] === null || row[columnMappings.ba1] === '');
                    
                    const extremite2Vide = (row[columnMappings.bp2] === undefined || row[columnMappings.bp2] === null || row[columnMappings.bp2] === '') && 
                                         (row[columnMappings.ba2] === undefined || row[columnMappings.ba2] === null || row[columnMappings.ba2] === '');
                    
                    const hasDiscontinuity = extremite1Vide || extremite2Vide;
                    
                    const tr = document.createElement('tr');
                    if (hasDiscontinuity) {
                        tr.classList.add('table-danger');
                    }
                    
                    tr.innerHTML = `
                        <td><span class="status-indicator ${hasDiscontinuity ? 'status-discontinu' : 'status-ok'}"></span></td>
                        <td>${row[columnMappings.code] || ''}</td>
                        <td>${row[columnMappings.etiquet] || ''}</td>
                        <td>${row[columnMappings.nd1] || ''}</td>
                        <td>${row[columnMappings.nd2] || ''}</td>
                        <td class="${(row[columnMappings.bp1] === undefined || row[columnMappings.bp1] === null || row[columnMappings.bp1] === '') ? 'table-danger' : ''}">${row[columnMappings.bp1] || ''}</td>
                        <td class="${(row[columnMappings.ba1] === undefined || row[columnMappings.ba1] === null || row[columnMappings.ba1] === '') ? 'table-danger' : ''}">${row[columnMappings.ba1] || ''}</td>
                        <td class="${(row[columnMappings.bp2] === undefined || row[columnMappings.bp2] === null || row[columnMappings.bp2] === '') ? 'table-danger' : ''}">${row[columnMappings.bp2] || ''}</td>
                        <td class="${(row[columnMappings.ba2] === undefined || row[columnMappings.ba2] === null || row[columnMappings.ba2] === '') ? 'table-danger' : ''}">${row[columnMappings.ba2] || ''}</td>
                        <td>${row[columnMappings.typelog] || ''}</td>
                        <td>${row[columnMappings.lgreel] || ''}</td>
                    `;
                    
                    resultBody.appendChild(tr);
                });
            }

            // Fonction pour exporter les discontinuités en CSV
            function exportToCSV() {
                const dataToExport = showOnlyDiscontinuites ? discontinuitesData : allData;
                if (dataToExport.length === 0) {
                    alert('Aucune donnée à exporter');
                    return;
                }
                
                // Créer un CSV à partir des données
                const csv = Papa.unparse(dataToExport, {
                    delimiter: ';',
                    header: true
                });
                
                // Créer un objet Blob et un lien de téléchargement
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', 'cables_analyse.csv');
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Gestionnaires d'événements
            analyseBtn.addEventListener('click', function() {
                const file = csvFileInput.files[0];
                if (file) {
                    analyseCSV(file);
                } else {
                    alert('Veuillez sélectionner un fichier CSV');
                }
            });

            loadSampleBtn.addEventListener('click', function() {
                analyseCSVString(sampleData);
            });

            exportBtn.addEventListener('click', exportToCSV);

            filterBtn.addEventListener('click', function() {
                showOnlyDiscontinuites = !showOnlyDiscontinuites;
                filterBtn.textContent = showOnlyDiscontinuites 
                    ? 'Afficher tous les câbles' 
                    : 'Afficher uniquement les discontinuités';
                renderTable(showOnlyDiscontinuites ? discontinuitesData : allData);
            });
            
            debugBtn.addEventListener('click', function() {
                debugSection.style.display = debugSection.style.display === 'none' ? 'block' : 'none';
            });

            // Chargez le fichier automatiquement s'il y en a un
            csvFileInput.addEventListener('change', function() {
                const file = csvFileInput.files[0];
                if (file) {
                    analyseCSV(file);
                }
            });

            // Charger l'exemple au démarrage pour démonstration
            window.addEventListener('load', function() {
                setTimeout(() => {
                    loadSampleBtn.click();
                }, 500);
            });
        });
    </script>
</body>
</html>
